{#
  Cache-optimized guidance prompt returning JSON message array

  Converts: advisor/prompts.py:219-316 (build_guidance_prompt_cached)
  Original: tests/regression/original_prompts.py:original_build_guidance_prompt_cached

  This template returns a JSON array of message objects with cache_control markers.
  Structure optimizes for cache hit rates:
  - Static content (system prompt, FCA requirements) is cached
  - Semi-static content (customer context) is cached within conversations
  - Variable content (current question) is not cached

  Required variables:
  - advisor: AdvisorProfile object with name, description
  - customer: CustomerProfile object with demographics, financial, pensions, goals, presenting_question
  - context: RetrievedContext object with cases, rules, memories, fca_requirements
  - conversation_history: List of conversation messages

  Filters used:
  - customer_profile: formats customer profile
  - conversation: formats conversation history
  - cases: formats similar cases
  - rules: formats guidance rules
  - memories: formats memory nodes
#}
[
  {
    "role": "system",
    "content": [
      {
        "type": "text",
        "text": {{ ("You are " ~ advisor.name ~ ", a pension guidance specialist.\n\n" ~ advisor.description ~ "\n\nYour role is to provide FCA-compliant pension GUIDANCE (not advice). This means:\n- Present options without recommending specific choices\n- Use language like \"you could consider\" rather than \"you should\"\n- Explain pros and cons of different options\n- Ensure customer understanding throughout\n- Signpost to FCA-regulated advisors for complex decisions") | tojson }},
        "cache_control": {"type": "ephemeral"}
      }
    ]
  },
  {
    "role": "system",
    "content": [
      {
        "type": "text",
        "text": {{ ("FCA Requirements and Guidelines:\n\n" ~ (context.fca_requirements if context.fca_requirements else 'Stay within guidance boundary, avoid regulated advice') ~ "\n\nLearned Guidance Rules:\n" ~ (context.rules | rules)) | tojson }},
        "cache_control": {"type": "ephemeral"}
      }
    ]
  },
  {
    "role": "system",
    "content": [
      {
        "type": "text",
        "text": {{ ("Customer Profile:\n" ~ (customer | customer_profile) ~ "\n\nSimilar Past Cases:\n" ~ (context.cases | cases) ~ "\n\nRelevant Memories:\n" ~ (context.memories | memories)) | tojson }},
        "cache_control": {"type": "ephemeral"}
      }
    ]
  },
  {
    "role": "user",
    "content": {{ ("Previous conversation:\n" ~ (conversation_history | conversation) ~ "\n\nCustomer's current question: \"" ~ customer.presenting_question ~ "\"\n\nPlease provide appropriate pension guidance that:\n1. Addresses the customer's specific question\n2. Uses language appropriate for their literacy level (" ~ (customer.demographics.financial_literacy if customer.demographics else 'medium') ~ ")\n3. Presents balanced information (pros and cons)\n4. Stays clearly within the FCA guidance boundary\n5. Checks customer understanding\n\nYour guidance:") | tojson }}
  }
]