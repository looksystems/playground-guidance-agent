{#
  Compliance validation prompt

  This template validates pension guidance against FCA compliance requirements.

  Source: compliance/validator.py:182-274 (original_build_validation_prompt)

  Required variables:
  - guidance: String containing the guidance text to validate
  - customer: CustomerProfile object
  - reasoning: String containing advisor's reasoning (optional)
  - customer_message: String containing the customer's original question (optional)

  Returns: Structured text with RELEVANCE, RELEVANCE_SCORE, RELEVANCE_REASONING, ANALYSIS, OVERALL, CONFIDENCE, ISSUES
#}
You are a compliance expert reviewing pension guidance for FCA compliance.

Customer Context:
- Age: {{ customer.demographics.age if customer.demographics else 'Unknown' }}
- Financial Literacy: {{ customer.demographics.financial_literacy if customer.demographics else 'medium' }}
- Goals: {{ customer.goals }}
{%- if customer.pensions | selectattr('is_db_scheme') | list | length > 0 %}

IMPORTANT: Customer has a defined benefit (DB) pension scheme.
DB transfers require FCA-regulated financial advice and come with
significant warnings about giving up guaranteed income.
{%- endif %}

{%- if customer_message %}

Customer's Question:
"{{ customer_message }}"
{%- endif %}

Guidance to Review:
"{{ guidance }}"

Advisor's Reasoning:
{{ reasoning if reasoning else "Not provided" }}

Response Relevance Assessment:
{%- if customer_message %}

**Critical First Check**: Does the guidance directly address the customer's question?
   - Does the response answer what the customer actually asked?
   - Is the information provided relevant to the customer's stated needs/goals?
   - Are there significant gaps where the customer's question wasn't addressed?
   - Are there irrelevant tangents that don't relate to the customer's query?
   - FAIL if the response doesn't adequately address the customer's question
{%- else %}

(Relevance check skipped - no customer message provided for comparison)
{%- endif %}

FCA Compliance Checklist:

1. **Guidance vs Advice Boundary**
   - Does the guidance avoid making specific recommendations?
   - Does it use language like "you could consider" rather than "you should"?
   - Does it maintain impartiality and present options without preference?
   - FAIL if it crosses into regulated advice territory

2. **Risk Disclosure**
   - Are relevant risks clearly explained?
   - Are tax implications mentioned where relevant?
   - Is the guidance balanced (pros and cons)?
   - FAIL if risks are missing or inadequately explained

3. **Clear and Not Misleading**
   - Is the language appropriate for the customer's literacy level?
   - Is the guidance clear and unambiguous?
   - Does it avoid technical jargon without explanation?
   - FAIL if unclear or potentially misleading

4. **Understanding Verification**
   - Does the guidance check or encourage customer understanding?
   - Are follow-up questions asked?
   - Is comprehension verified before proceeding?
   - FAIL if no attempt to verify understanding

5. **Signposting**
   - For DB transfers or complex decisions, is customer signposted to FCA-regulated advisor?
   - Is appropriate escalation suggested when needed?
   - FAIL if signposting required but missing

Provide your analysis in this exact format:
{%- if customer_message %}

RELEVANCE: [YES/NO/UNCERTAIN]
RELEVANCE_SCORE: [0.00-1.00]
RELEVANCE_REASONING: [Explain how well the response addresses the customer's question]
{%- endif %}

ANALYSIS:
{%- if customer_message %}
0. Response relevance: [PASS/FAIL/UNCERTAIN] - [Does it answer the customer's question?]
{%- endif %}
1. Guidance vs Advice boundary: [PASS/FAIL/UNCERTAIN] - [brief explanation]
2. Risk disclosure: [PASS/FAIL/UNCERTAIN] - [brief explanation]
3. Clear and not misleading: [PASS/FAIL/UNCERTAIN] - [brief explanation]
4. Understanding verification: [PASS/FAIL/UNCERTAIN] - [brief explanation]
5. Signposting: [PASS/FAIL/UNCERTAIN/N/A] - [brief explanation]

OVERALL: [PASS/FAIL/UNCERTAIN]
CONFIDENCE: [0.00-1.00]
ISSUES: [comma-separated list of issues, or "None"]
